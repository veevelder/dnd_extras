Macro:
Name: Stop Combat
Image: systems/dnd5e/icons/skills/weapon_15.jpg
Scope: global
Type: script
Command:
async function endCombat() {
	//get exp
	let exp = 0;
	let defeated = [];
	//actor.data.data.details.xp.value
	game.combat.combatants.filter(x => x.players.length == 0).filter(x => x.css.includes("defeated")).forEach(function(a) { exp += a.actor.data.data.details.xp.value; defeated.push(a.name); });
	exp = Math.round(exp / game.combat.combatants.filter(x => x.players.length > 0).length);
	game.playlists.entities.find(data => data.name == "Combat").stopAll();
	game.combat.delete();
	if (exp != 0 ) {
		ChatMessage.create({
			user: game.user._id,
			content: "<p>For defeating <strong>" + defeated.join(", ") + "</strong> each of you get <strong>" + exp + "</strong> experience!</p>",
			type: CONST.CHAT_MESSAGE_TYPES.OTHER
		}, {});
	}
	if(CONFIG["OldPlaylist"]) {
		CONFIG["OldPlaylist"].forEach(function(a) {a.playAll()});
		CONFIG["OldPlaylist"] = null;
	}
}

if (game.combat) {
	let d = Dialog.confirm({
      title: "End Combat Encounter?",
      content: "<p>End this combat encounter and empty the turn tracker?</p>",
      yes: () => endCombat()
    });
}
else {
	let d = new Dialog({
		title: "No Combat Started",
		content: "<p>You must start a Combat before ending one.</p>",
		buttons: {
			one: {
				icon: '<i class="fas fa-check"></i>',
				label: "Ok"
			},
		},
		default: "one",
	}).render(true);
}